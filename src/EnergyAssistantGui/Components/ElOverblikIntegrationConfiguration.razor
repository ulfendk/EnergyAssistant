@using UlfenDk.EnergyAssistant.Config
@using UlfenDk.EnergyAssistant.Database
@using UlfenDk.EnergyAssistant.Repository
@namespace EnergyAssistant.Components

@inject EnergyAssistantRepository Repository

<MudCard Class="@Class">
    <MudCardHeader Style="background-color: rgb(10, 81, 93)">
        <MudLink Target="_blank" Href="https://eloverblik.dk/"><MudImage Src="logos/logo_eloverblik.png" Height="50"/></MudLink>
    </MudCardHeader>
@if (_settings == null)
{
    <MudProgressCircular Color="Color.Default" Indeterminate="true" />
}
else
{
    <MudCardContent>
        <MudText Typo="Typo.body1" GutterBottom="true">To enable accurate insights into energy consumption and correct price calculation, you can enable ElOverblik.</MudText>
        <MudText Typo="Typo.body2" GutterBottom="true">The calculations are time-skewed and lagging two days behind.</MudText>
        <MudForm>
            <MudCheckBox @bind-Checked="_settings.IsEnabled" T="bool" Label="Enabled"/>
            <MudTextField @bind-Value="_settings.MeteringPointId" T="string" Label="Metering point ID" HelperText="The metering point ID to load usage for." Variant="Variant.Text"/>
            <MudTextField @bind-Value="_settings.ApiToken" T="string" Label="Token" HelperText="The API access token." Variant="Variant.Text"/>
        </MudForm>
    </MudCardContent>
    <MudCardActions>
        <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="(async () => await OnSaveClickedAsync())">Save</MudButton>
        <MudButton Variant="Variant.Text" Color="Color.Primary">Reset</MudButton>
    </MudCardActions>
}
</MudCard>

@code {
    [Parameter]
    public string Class { get; set; } = "";

    private ElOverblikSettings? _settings;
    
    protected override async Task OnInitializedAsync()
    {
        _settings = await Repository.GetElOverblikSettingsAsync();

        await base.OnInitializedAsync();
    }

    private async Task OnSaveClickedAsync()
    {
        await Repository.UpdateElOverblikSettingsAsync(s =>
        {
            s.IsEnabled = _settings!.IsEnabled;
        });
    }

}