@using UlfenDk.EnergyAssistant.Config
@using UlfenDk.EnergyAssistant.Database
@using UlfenDk.EnergyAssistant.Repository
@using System.Collections.ObjectModel
@using EnergyAssistant.ViewModels
@namespace EnergyAssistant.Components

@inject EnergyAssistantRepository Repository

<style>
    .mud-timeline-item { cursor: pointer; }  /* change the mouse cursor to indicate that MudTimelineItems are clickable */
</style>

@* <MudTimeline @onclick="OnClick" @bind-SelectedIndex="@selectedIndex" TimelinePosition="TimelinePosition.Left"> *@
@*     <MudTimelineItem>Meeting 1</MudTimelineItem> *@
@*     <MudTimelineItem>Meeting 2</MudTimelineItem> *@
@*     <MudTimelineItem>Meeting 3</MudTimelineItem> *@
@* </MudTimeline> *@
<MudCard Class="@Class">
    <MudCardHeader>
        <CardHeaderContent>
            <MudText Typo="Typo.h6">Fees and tariffs</MudText>

        </CardHeaderContent>
    </MudCardHeader>
@if (_yearPeriods == null)
{
    <MudProgressCircular Color="Color.Default" Indeterminate="true" />
}
else
{
    <MudCardContent>
        @foreach (var yearPeriod in _yearPeriods)
        {
            <MudForm>
                <MudText Typo="Typo.h6"><MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Style="vertical-align: middle"/>@yearPeriod.Year</MudText>
                <MudTextField T="decimal" Label="VAT" @bind-Value="yearPeriod.Vat"/>
            </MudForm>


            @* <MudFab StartIcon="@Icons.Material.Filled.Add" OnClick="() => AddItem(yearPeriod.YearlyCosts)" Color="Color.Primary" /> *@
            <MudButton OnClick="() => AddItem(yearPeriod.YearlyCosts)" Color="@Color.Success" Class="add-item-btn">Add Item</MudButton>
            @* <MudButton OnClick="() => RemoveItem(yearPeriod.YearlyCosts)" Color="@Color.Error" Class="remove-item-btn">Remove Item</MudButton> *@
            <MudDataGrid Groupable="true" GroupClassFunc="GroupClassFunc" Bordered="false" Class="mt-6" T="FeeViewModel" Items="@yearPeriod.YearlyCosts" ReadOnly="false" EditMode="DataGridEditMode.Form" EditTrigger="DataGridEditTrigger.OnRowClick">
                <Columns>
                    <PropertyColumn Property="x => x.Name" Title="Name">
                        <EditTemplate>
                            <MudTextField @bind-Value="context.Item.Name" Label="Name" Variant="Variant.Outlined" Class="mx-8"/>
                        </EditTemplate>
                    </PropertyColumn>
                    <PropertyColumn Property="x => x.Amount" Title="Amount">
                        <EditTemplate>
                            <MudTextField @bind-Value="context.Item.Amount" Label="Amount" Variant="Variant.Outlined" Adornment="Adornment.End" AdornmentText="DKK / kWh" Class="mx-8"/>
                        </EditTemplate>
                    </PropertyColumn>
                    <TemplateColumn Title="Action">
                        <CellTemplate>
                            <MudIconButton OnClick="@context.Actions.StartEditingItemAsync" Icon="@Icons.Material.Outlined.Edit" Size="@Size.Small" Title="Edit"/>
                            <MudIconButton OnClick="async () => RemoveItemAsync(yearPeriod.YearlyCosts, context.Item)" Icon="@Icons.Material.Outlined.Delete" Size="@Size.Small" Title="Delete"/>
                        </CellTemplate>
                    </TemplateColumn>
                </Columns>
            </MudDataGrid>
        }
    </MudCardContent>
    <MudCardActions>
        <MudButton Variant="Variant.Text" Color="Color.Primary">Save</MudButton>
        <MudButton Variant="Variant.Text" Color="Color.Primary">Reset</MudButton>
    </MudCardActions>
}
</MudCard>

@code {
    [Parameter] public string Class { get; set; } = "";
    
    [Inject] private IDialogService DialogService { get; set; }

    private ObservableCollection<YearPeriodViewModel>? _yearPeriods;
    private ObservableCollection<MonthPeriod>? _monthPeriods;
    private string GroupClassFunc(GroupDefinition<FeeViewModel> item)
    {
        return item.Grouping.Key?.ToString() == "Nonmetal" || item.Grouping.Key?.ToString() == "Other"
            ? "mud-theme-warning"
            : string.Empty;
    }
    protected override async Task OnInitializedAsync()
    {
        _yearPeriods = new ObservableCollection<YearPeriodViewModel>((await Repository.GetYearlyPeriodsAsync()).Select(x => new YearPeriodViewModel(x)));
        
        var yearPeriod = new YearPeriod
        {
            Year = 2023,
            Vat = 0.25m,
            Id = 1
        };
        yearPeriod.YearlyCosts.Add(new Fee
        {
            Id = 1,
            Amount = 0.123m,
            Name = "Netabonnement"
        });
        _yearPeriods.Add(new YearPeriodViewModel(yearPeriod));
        
        // _monthPeriods = new ObservableCollection<MonthPeriodViewModel>((await Repository.GetMonthPeriodsAsync()).Select(x => new MonthPeriodViewModel(x)));

        await base.OnInitializedAsync();
    }
    
    private async Task OnCreatePeriodClickedAsync()
    {
        // _yearPeriods.Add(new YearPeriod
        // {
        //     Vat = 0.25m,
        //     Year = DateTimeOffset.Now.Year
        // });
        // await Repository.UpdateGeneralSettingsAsync(s =>
        // {
        //     s.Region = _settings!.Region;
        //     s.HasElectricHeating = _settings!.HasElectricHeating;
        // });
    }
    
    void AddItem(ObservableCollection<FeeViewModel> items)
    {
        items.Add(new FeeViewModel(new Fee{ Name = "New", Amount = 0m}));
    }

    async Task RemoveItemAsync(ObservableCollection<FeeViewModel> items, FeeViewModel item)
    {
        if (items.Any() &&
            await DialogService.ShowMessageBox(
                "Warning", 
                $"Are you sure you want to delete {item.Name}?", 
                yesText:"Delete", cancelText:"Cancel") == true)
        {
            items.Remove(item);
            StateHasChanged();
        }
    }
}