@page "/predictions"
@inject SpotPriceCollection SpotPrices

@* *@
@* <PageTitle>Carnot.dk</PageTitle> *@
@* *@
@* <MudText Typo="Typo.h3" GutterBottom="true">Carnot.dk</MudText> *@
@* <MudText Class="mb-4">Configure your Carnot.dk account, to enable energy price forecasts:</MudText> *@
@* <MudText Class="mb-4">Enabled:</MudText> *@
@* <MudText Class="mb-4">True</MudText> *@
@* <MudText Class="mb-4">Username:</MudText> *@
@* <MudText Class="mb-4">noone@nowhere.com</MudText> *@
@* <MudText Class="mb-4">API token:</MudText> *@
@* <MudText Class="mb-4">ABCDEFG</MudText> *@
@* <MudButton Color="Color.Primary" Variant="Variant.Filled" @onclick="IncrementCount">Click me</MudButton> *@
@* *@
@* *@
@* @code { *@
@*     private int currentCount = 0; *@
@* *@
@*     private void IncrementCount() *@
@*     { *@
@*         currentCount++; *@
@*     } *@
@* } *@
<PageTitle>Predictions</PageTitle>
@using System.Text.RegularExpressions
@using System.ComponentModel.DataAnnotations
@using UlfenDk.EnergyAssistant.Model
<MudText Typo="Typo.h3" GutterBottom="true">Predictions</MudText>
<MudLink Target="_blank" Href="https://www.carnot.dk/"><MudImage Src="https://www.carnot.dk/img/logo.png" Height="50" /></MudLink>
<MudText Typo="Typo.h6" GutterBottom="true">To enable predictions, you need to create an account at CARNOT. It is free for non-commercial use.</MudText>
<MudText Typo="Typo.h6" GutterBottom="true">Click the image above to create your account.</MudText>

<MudGrid>
    <MudItem xs="12" sm="7">
        <MudPaper Class="pa-4">
            <MudForm @ref="form" @bind-IsValid="@success" @bind-Errors="@errors">
                <MudCheckBox T="bool" Label="Enabled" />
                <MudTextField T="string" Label="Username" HelperText="Email address used for your carnot.dk account" Required="true" RequiredError="Email is required!"
                              Validation="@(new EmailAddressAttribute() { ErrorMessage = "The email address is invalid" })"/>
                <MudTextField T="string" Label="API key" HelperText="API key from carnot.dk" @ref="pwField1"
                              InputType="InputType.Password"
                              Validation="@(new Func<string, IEnumerable<string>>(PasswordStrength))" Required="true"
                              RequiredError="API key is required!"/>
                @* <div class="d-flex"> *@
                @*     <MudRadioGroup T="string" Required="true" RequiredError="Account type is required!"> *@
                @*         <MudRadio Option="@("Personal")">Personal</MudRadio> *@
                @*         <MudRadio Option="@("Professional")">Professional</MudRadio> *@
                @*     </MudRadioGroup> *@
                @* </div> *@
                @* <div class="d-flex align-center justify-space-between"> *@
                @*     <MudCheckBox T="bool" Required="true" RequiredError="You must agree" Label="I agree!"/> *@
                @*     <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="@(!success)" Class="ml-auto">Register</MudButton> *@
                @* </div> *@
            </MudForm>   
        </MudPaper>
        <MudPaper Class="pa-4 mt-4">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" DisableElevation="true" OnClick="@(()=>form.Validate())">Save</MudButton>
            @* <MudButton Variant="Variant.Filled" Color="Color.Secondary" DisableElevation="true" OnClick="@(()=>form.ResetAsync())" Class="mx-2">Reset</MudButton> *@
            @* <MudButton Variant="Variant.Filled" DisableElevation="true" OnClick="@(()=>form.ResetValidation())">Reset Validation</MudButton> *@
        </MudPaper>
    </MudItem>
    <MudItem xs="12" sm="5">
        <MudPaper Class="pa-4 mud-height-full">
            <MudText Typo="Typo.subtitle2">@($"Errors ({errors.Length})")</MudText>
                @foreach (var error in errors)
                {
                    <MudText Color="@Color.Error">@error</MudText>
                }
        </MudPaper>
    </MudItem>
</MudGrid>

<MudTable Items="SpotPrices" Hover="true" SortLabel="Sort By" Elevation="0" GroupBy="@_groupDefinition" @ref="_tableref">
    <HeaderContent>
        <MudTh><MudTableSortLabel InitialDirection="SortDirection.Ascending" SortBy="new Func<UlfenDk.EnergyAssistant.Model.SpotPrice, object>(x=>x.Hour)">Hour</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<UlfenDk.EnergyAssistant.Model.SpotPrice, object>(x=>x.CalculatedPriceRegularTariff)">Normal price (DKK/kWh)</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<UlfenDk.EnergyAssistant.Model.SpotPrice, object>(x=>x.RegularPriceLevel)">Normalt niveau</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<UlfenDk.EnergyAssistant.Model.SpotPrice, object>(x=>x.CalculatedPriceReducedTariff)">Reduceret pris (DKK/kWh)</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<UlfenDk.EnergyAssistant.Model.SpotPrice, object>(x=>x.ReducedPriceLevel)">Recueret niveau</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<UlfenDk.EnergyAssistant.Model.SpotPrice, object>(x=>x.RawPrice!)">Rå pris  (DKK/kWh, ex. VAT)</MudTableSortLabel></MudTh>
    </HeaderContent>
    <GroupHeaderTemplate>
        <MudTh Class="mud-table-cell-custom-group" colspan="6"><MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" Style="vertical-align: middle"/> @(((DateTime)context.Key).ToString("dd/MM"))</MudTh>
    </GroupHeaderTemplate>
    <RowTemplate>
        <MudTd DataLabel="Hour"><MudIcon Icon="@Icons.Material.Filled.AccessTime"  Style="vertical-align: middle" Size="Size.Small" /> @context.Hour.ToString("HH") - @context.Hour.AddHours(1).ToString("HH")</MudTd>
        <MudTd DataLabel="Regular price">@context.CalculatedPriceRegularTariff.ToString("0.000")</MudTd>
        <MudTd DataLabel="Regular level">@context.RegularPriceLevel</MudTd>
        <MudTd DataLabel="Reduced price">@context.CalculatedPriceReducedTariff.ToString("0.000")</MudTd>
        <MudTd DataLabel="Reduced level">@context.ReducedPriceLevel</MudTd>
        <MudTd DataLabel="Raw price">@context.RawPrice.ToString("0.000")</MudTd>
    </RowTemplate>
    @* <PagerContent> *@
    @*     <MudTablePager  PageSizeOptions="new int[]{50, 100}" /> *@
    @* </PagerContent> *@
</MudTable>



@code {
    bool success;
    string[] errors = { };
    MudTextField<string> pwField1;
    MudForm form;

    private IEnumerable<string> PasswordStrength(string pw)
    {
        if (string.IsNullOrWhiteSpace(pw))
        {
            yield return "API key is required!";
            yield break;
        }
    }

    private MudTable<SpotPrice> _tableref;
    
    private TableGroupDefinition<SpotPrice> _groupDefinition = new()
    {
        GroupName = "Day",
        Indentation = false,
        Expandable = true,
        IsInitiallyExpanded = false,
        Selector = (e) => e.Hour.Date
    };
}